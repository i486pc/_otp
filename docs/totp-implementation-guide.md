# TOTP Implementation Guide

This guide explains how to implement Time-based One-Time Password (TOTP) authentication in your application, including the differences between simple OTP and TOTP, and how to integrate with authenticator apps.

## Table of Contents

1. [Introduction to TOTP](#introduction-to-totp)
2. [OTP vs TOTP Comparison](#otp-vs-totp-comparison)
3. [Implementation Steps](#implementation-steps)
4. [Backend Implementation](#backend-implementation)
5. [Frontend Implementation](#frontend-implementation)
6. [Database Schema](#database-schema)
7. [Security Considerations](#security-considerations)
8. [Integration with Authenticator Apps](#integration-with-authenticator-apps)
9. [Testing and Validation](#testing-and-validation)

## Introduction to TOTP

Time-based One-Time Password (TOTP) is an algorithm that generates a one-time password using:

1. A shared secret key
2. The current time

TOTP is defined in [RFC 6238](https://tools.ietf.org/html/rfc6238) and is widely used for two-factor authentication (2FA) in applications and services. It's the standard used by authenticator apps like Google Authenticator, Microsoft Authenticator, Authy, and others.

## OTP vs TOTP Comparison

### Simple OTP (One-Time Password)

- **Generation**: Random codes generated by the server
- **Storage**: Requires server-side storage of the code until verification
- **Delivery**: Sent to the user via SMS, email, etc.
- **Expiration**: Typically time-based but managed by the server
- **Security**: Vulnerable to interception during transmission
- **User Experience**: Requires waiting for delivery

### TOTP (Time-based One-Time Password)

- **Generation**: Based on a shared secret and current time
- **Storage**: Only the secret is stored, not individual codes
- **Delivery**: Generated by the user's device (no transmission needed)
- **Expiration**: Automatically expires after a short time window (typically 30 seconds)
- **Security**: No transmission of codes, more secure
- **User Experience**: Instant code generation, works offline

## Implementation Steps

1. **Generate a Secret Key**: Create a unique secret key for each user
2. **Store the Secret**: Securely store the secret in your database
3. **Generate QR Code**: Create a QR code for easy setup in authenticator apps
4. **Verify TOTP Codes**: Validate codes entered by users
5. **Enable/Disable TOTP**: Allow users to manage their TOTP settings

## Backend Implementation

### 1. Generate and Store Secret

```javascript
import { authenticator } from 'otplib';

// Generate a new secret
const secret = authenticator.generateSecret();

// Store the secret in your database
await db.users.update({
  where: { id: userId },
  data: { totpSecret: secret, totpEnabled: false }
});
```

### 2. Generate QR Code

```javascript
import QRCode from 'qrcode';

// Generate the OTP Auth URL
const serviceName = 'Your App Name';
const otpauth = authenticator.keyuri(user.email, serviceName, secret);

// Generate QR code as data URL
const qrCodeDataUrl = await QRCode.toDataURL(otpauth);
```

### 3. Verify TOTP Codes

```javascript
import { totp } from 'otplib';

// Configure TOTP options
totp.options = {
  digits: 6,
  step: 30, // 30 seconds validity
  window: 1  // Allow 1 step before/after for clock drift
};

// Verify the code
const isValid = totp.verify({
  token: userProvidedCode,
  secret: userSecret
});

if (isValid) {
  // Code is valid, proceed with authentication
} else {
  // Invalid code
}
```

### 4. Enable/Disable TOTP

```javascript
// Enable TOTP
app.post('/api/totp/enable', async (req, res) => {
  const { userId, code } = req.body;
  
  // Verify the code first
  const isValid = totp.verify({
    token: code,
    secret: user.totpSecret
  });
  
  if (isValid) {
    // Update user record to enable TOTP
    await db.users.update({
      where: { id: userId },
      data: { totpEnabled: true }
    });
    
    res.json({ success: true });
  } else {
    res.status(401).json({ error: 'Invalid code' });
  }
});

// Disable TOTP (requires verification)
app.post('/api/totp/disable', async (req, res) => {
  const { userId, code } = req.body;
  
  // Verify the code first
  const isValid = totp.verify({
    token: code,
    secret: user.totpSecret
  });
  
  if (isValid) {
    // Update user record to disable TOTP
    await db.users.update({
      where: { id: userId },
      data: { totpEnabled: false }
    });
    
    res.json({ success: true });
  } else {
    res.status(401).json({ error: 'Invalid code' });
  }
});
```

## Frontend Implementation

### 1. TOTP Setup Component

Create a component that:

1. Displays the QR code
2. Shows the secret key for manual entry
3. Provides a field for the user to enter the code
4. Verifies the code and enables TOTP

```jsx
import React, { useState, useEffect } from 'react';
import { setupTotp, enableTotp } from '../services/api';

const TotpSetup = ({ userId, onComplete }) => {
  const [secret, setSecret] = useState('');
  const [qrCode, setQrCode] = useState('');
  const [code, setCode] = useState('');
  
  useEffect(() => {
    // Fetch TOTP setup data
    const fetchSetup = async () => {
      const response = await setupTotp(userId);
      setSecret(response.secret);
      setQrCode(response.qrCode);
    };
    
    fetchSetup();
  }, [userId]);
  
  const handleEnable = async () => {
    const response = await enableTotp(userId, code);
    if (response.success) {
      onComplete();
    }
  };
  
  return (
    <div>
      <h2>Set Up Authenticator App</h2>
      
      <div>
        <p>Scan this QR code with your authenticator app:</p>
        <img src={qrCode} alt="TOTP QR Code" />
      </div>
      
      <div>
        <p>Or enter this code manually:</p>
        <code>{secret}</code>
      </div>
      
      <div>
        <p>Enter the code from your authenticator app:</p>
        <input
          type="text"
          value={code}
          onChange={(e) => setCode(e.target.value)}
        />
        <button onClick={handleEnable}>Verify and Enable</button>
      </div>
    </div>
  );
};
```

### 2. TOTP Verification Component

Create a component for verifying TOTP codes during login:

```jsx
import React, { useState } from 'react';
import { verifyTotp } from '../services/api';

const TotpVerification = ({ userId, onSuccess }) => {
  const [code, setCode] = useState('');
  const [error, setError] = useState('');
  
  const handleVerify = async () => {
    try {
      const response = await verifyTotp(userId, code);
      if (response.success) {
        onSuccess();
      } else {
        setError('Invalid code');
      }
    } catch (error) {
      setError('Verification failed');
    }
  };
  
  return (
    <div>
      <h2>Enter Authenticator Code</h2>
      
      {error && <p className="error">{error}</p>}
      
      <div>
        <p>Enter the code from your authenticator app:</p>
        <input
          type="text"
          value={code}
          onChange={(e) => setCode(e.target.value)}
        />
        <button onClick={handleVerify}>Verify</button>
      </div>
    </div>
  );
};
```

## Database Schema

Add the following fields to your user table:

```sql
ALTER TABLE users ADD COLUMN totp_secret TEXT;
ALTER TABLE users ADD COLUMN totp_enabled BOOLEAN DEFAULT false;
```

## Security Considerations

1. **Secret Storage**: Store TOTP secrets securely, preferably encrypted
2. **Rate Limiting**: Implement rate limiting to prevent brute force attacks
3. **Backup Codes**: Provide backup codes for users who lose access to their authenticator app
4. **Recovery Options**: Implement a secure recovery process
5. **Time Synchronization**: Account for time drift between server and client
6. **Secure Transmission**: Use HTTPS for all communications

## Integration with Authenticator Apps

TOTP is compatible with most authenticator apps, including:

- Google Authenticator
- Microsoft Authenticator
- Authy
- LastPass Authenticator
- 1Password
- Bitwarden

These apps follow the same TOTP standard (RFC 6238), so your implementation will work with all of them.

## Testing and Validation

1. **Unit Tests**: Test TOTP generation and verification
2. **Integration Tests**: Test the full authentication flow
3. **Manual Testing**: Test with actual authenticator apps
4. **Edge Cases**: Test time drift, invalid codes, etc.
5. **Security Testing**: Perform security audits and penetration testing

Example test cases:

```javascript
// Test TOTP verification
test('should verify valid TOTP code', () => {
  const secret = 'JBSWY3DPEHPK3PXP';
  const code = totp.generate(secret);
  
  expect(totp.verify({ token: code, secret })).toBe(true);
});

// Test invalid code
test('should reject invalid TOTP code', () => {
  const secret = 'JBSWY3DPEHPK3PXP';
  
  expect(totp.verify({ token: '000000', secret })).toBe(false);
});

// Test time window
test('should accept code within time window', () => {
  const secret = 'JBSWY3DPEHPK3PXP';
  const code = totp.generate(secret);
  
  // Fast-forward time by 29 seconds (still within 30-second window)
  jest.advanceTimersByTime(29000);
  
  expect(totp.verify({ token: code, secret })).toBe(true);
});
```

By following this guide, you can implement a secure and user-friendly TOTP authentication system in your application.